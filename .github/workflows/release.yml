name: Release
on:
    push:
        tags:
            - "*"

jobs:
    release:
        permissions:
            contents: write
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: "macos-14" # Apple Silicon
                      os: "macos-14"
                      target: "aarch64-apple-darwin"
                      sidecar_target: "aarch64-apple-darwin"
                    - platform: "windows-latest"
                      os: "windows-latest"
                      target: "x86_64-pc-windows-msvc"
                      sidecar_target: "x86_64-pc-windows-msvc.exe"

        runs-on: ${{ matrix.os }}

        steps:
            - uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install Poetry
              run: |
                  pip install poetry

            - name: Install Python Dependencies
              run: |
                  cd app
                  poetry install --no-root
                  poetry run pip install pyinstaller

            - name: Build Python Backend
              shell: bash
              run: |
                  cd app
                  poetry run pyinstaller server.py \
                    --name titier-backend \
                    --onefile \
                    --collect-all llama_cpp \
                    --collect-all sentence_transformers \
                    --collect-all qdrant_client

            - name: Prepare Sidecar
              shell: bash
              run: |
                  mkdir -p frontend/src-tauri/sidecars
                  if [ "${{ matrix.os }}" == "windows-latest" ]; then
                    mv app/dist/titier-backend.exe frontend/src-tauri/sidecars/titier-backend-${{ matrix.sidecar_target }}
                  else
                    mv app/dist/titier-backend frontend/src-tauri/sidecars/titier-backend-${{ matrix.sidecar_target }}
                  fi

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Install Frontend Dependencies
              run: |
                  cd frontend
                  npm install

            - name: Build Tauri App
              run: |
                  cd frontend
                  npm run tauri build -- --target ${{ matrix.target }}

            - name: Rename & Finalize Assets
              shell: bash
              run: |
                  # Get version digits only (e.g., v0.2.0 or Titier-0.2.0 -> 0.2.0)
                  TAG_NAME=${{ github.ref_name }}
                  VERSION=$(echo $TAG_NAME | grep -oE "[0-9]+\.[0-9]+\.[0-9]+")
                  echo "Detected version: $VERSION"
                  echo "VERSION=$VERSION" >> $GITHUB_ENV

                  if [ "${{ matrix.os }}" == "windows-latest" ]; then
                    cd frontend/src-tauri/target/${{ matrix.target }}/release/bundle/nsis
                    FOUND_EXE=$(ls *.exe 2>/dev/null | head -n 1)
                    if [ -z "$FOUND_EXE" ]; then echo "Error: EXE not found"; exit 1; fi
                    NEW_NAME="Titier_${VERSION}_x64.exe"
                    mv "$FOUND_EXE" "$NEW_NAME"
                    echo "ARTIFACT_PATH=frontend/src-tauri/target/${{ matrix.target }}/release/bundle/nsis/$NEW_NAME" >> $GITHUB_ENV
                  else
                    cd frontend/src-tauri/target/${{ matrix.target }}/release/bundle/dmg
                    FOUND_DMG=$(ls *.dmg 2>/dev/null | head -n 1)
                    if [ -z "$FOUND_DMG" ]; then echo "Error: DMG not found"; exit 1; fi
                    NEW_NAME="Titier_${VERSION}_aarch64.dmg"
                    mv "$FOUND_DMG" "$NEW_NAME"
                    echo "ARTIFACT_PATH=frontend/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/$NEW_NAME" >> $GITHUB_ENV
                  fi

            - name: Extract Release Notes
              shell: bash
              run: |
                  # Use version digits
                  V="${{ env.VERSION }}"
                  if [ -z "$V" ]; then V=$(echo "${{ github.ref_name }}" | grep -oE "[0-9]+\.[0-9]+\.[0-9]+"); fi
                  echo "Extracting notes for version: $V"
                  # Use a simpler sed command and escape brackets to satisfy YAML if needed
                  # or just use a temporary variable
                  SEARCH_PATTERN="## \[$V\]"
                  sed -n "/$SEARCH_PATTERN/,/## \[/p" CHANGELOG.md | sed '1d;$d' > release_notes.md
                  if [ ! -s release_notes.md ]; then
                    echo "Release $V" > release_notes.md
                  fi

            - name: Upload Release Assets
              uses: softprops/action-gh-release@v1
              if: startsWith(github.ref, 'refs/tags/')
              with:
                  body_path: release_notes.md
                  files: ${{ env.ARTIFACT_PATH }}
                  draft: true
                  name: "Titier v${{ env.VERSION }}"
                  tag_name: ${{ github.ref_name }}
