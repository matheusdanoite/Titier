name: Release
on:
    push:
        tags:
            - "*"

jobs:
    release:
        permissions:
            contents: write
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: "macos-14" # Apple Silicon
                      os: "macos-14"
                      target: "aarch64-apple-darwin"
                      sidecar_target: "aarch64-apple-darwin"
                    - platform: "windows-latest"
                      os: "windows-latest"
                      target: "x86_64-pc-windows-msvc"
                      sidecar_target: "x86_64-pc-windows-msvc.exe"

        runs-on: ${{ matrix.os }}

        steps:
            - uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install Poetry
              run: |
                  pip install poetry

            - name: Install Python Dependencies
              run: |
                  cd app
                  poetry install --no-root
                  poetry run pip install pyinstaller

            - name: Build Python Backend
              shell: bash
              run: |
                  cd app
                  poetry run pyinstaller server.py \
                    --name titier-backend \
                    --onefile \
                    --collect-all llama_cpp \
                    --collect-all sentence_transformers \
                    --collect-all qdrant_client

            - name: Prepare Sidecar
              shell: bash
              run: |
                  mkdir -p frontend/src-tauri/sidecars
                  if [ "${{ matrix.os }}" == "windows-latest" ]; then
                    mv app/dist/titier-backend.exe frontend/src-tauri/sidecars/titier-backend-${{ matrix.sidecar_target }}
                  else
                    mv app/dist/titier-backend frontend/src-tauri/sidecars/titier-backend-${{ matrix.sidecar_target }}
                  fi

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Install Frontend Dependencies
              run: |
                  cd frontend
                  npm install

            - name: Build Tauri App
              run: |
                  cd frontend
                  npm run tauri build

            - name: Rename Artifacts (Windows)
              if: matrix.os == 'windows-latest'
              shell: bash
              run: |
                  # Find the .exe file (likely contains version and possibly language)
                  # We want to rename it to strictly Titier_VERSION_x64.exe

                  # Get version from tag (remove v prefix)
                  VERSION=${GITHUB_REF_NAME#v}

                  cd frontend/src-tauri/target/release/bundle/nsis

                  # Find the generated exe
                  FOUND_EXE=$(ls *.exe | head -n 1)

                  # Define new name
                  NEW_NAME="Titier_${VERSION}_x64.exe"

                  mv "$FOUND_EXE" "$NEW_NAME"
                  echo "Renamed $FOUND_EXE to $NEW_NAME"
                  echo "ARTIFACT_PATH=frontend/src-tauri/target/release/bundle/nsis/$NEW_NAME" >> $GITHUB_ENV

            - name: Rename Artifacts (macOS)
              if: matrix.os == 'macos-14'
              shell: bash
              run: |
                  # Get version from tag
                  VERSION=${GITHUB_REF_NAME#v}

                  cd frontend/src-tauri/target/release/bundle/dmg

                  FOUND_DMG=$(ls *.dmg | head -n 1)
                  NEW_NAME="Titier_${VERSION}_aarch64.dmg"

                  mv "$FOUND_DMG" "$NEW_NAME"
                  echo "Renamed $FOUND_DMG to $NEW_NAME"
                  echo "ARTIFACT_PATH=frontend/src-tauri/target/release/bundle/dmg/$NEW_NAME" >> $GITHUB_ENV

            - name: Extract Release Notes
              id: extract_release_notes
              shell: bash
              run: |
                  # Extract the changelog entry for this version
                  VERSION=${GITHUB_REF_NAME#v}
                  sed -n "/^## \[$VERSION\]/,/^## \[/p" CHANGELOG.md | sed '1d;$d' > release_notes.md

                  # If empty, just use the tag name
                  if [ ! -s release_notes.md ]; then
                    echo "Release $VERSION" > release_notes.md
                  fi

            - name: Upload Release Assets
              uses: softprops/action-gh-release@v1
              if: startsWith(github.ref, 'refs/tags/')
              with:
                  body_path: release_notes.md
                  files: ${{ env.ARTIFACT_PATH }}
                  draft: true
                  prerelease: false
